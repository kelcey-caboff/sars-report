<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bucket Editor Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root { --bg:#f7f7f9; --card:#fff; --muted:#7a7a7a; --border:#e3e3e3; --gold:#ffbf00;}
  body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); }
  header { display:flex; gap:.5rem; padding:12px; position:sticky; top:0; background:var(--bg); border-bottom:1px solid var(--border); z-index:2; }
  input[type="search"] { flex:1; padding:.5rem .75rem; border:1px solid var(--border); border-radius:10px; }
  .btn { border:1px solid var(--border); background:var(--card); padding:.45rem .7rem; border-radius:10px; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; border-color:#111; }
  .board { display:flex; gap:12px; padding:12px; align-items:flex-start; flex-wrap:nowrap; overflow:auto; }
  .col { background:var(--card); border:1px solid var(--border); border-radius:12px; width:290px; min-width:290px; display:flex; flex-direction:column; }
  .col header { display:flex; gap:8px; align-items:center; border-bottom:1px solid var(--border); background:transparent; position:static; padding:10px; }
  .col header input { flex:1; border:1px dashed var(--border); padding:.35rem .5rem; border-radius:8px; }
  .list { padding:8px; display:flex; flex-direction:column; gap:6px; min-height:60px; }
  .card { border:1px solid var(--border); border-radius:10px; padding:.5rem .6rem; background:#fff; display:flex; align-items:center; gap:8px; }
  .card[data-gold="true"] { border-color:var(--gold); box-shadow:0 0 0 2px color-mix(in oklab, var(--gold) 25%, transparent); }
  .star { color:var(--gold); font-size:14px; width:1.2em; text-align:center; }
  .muted { color:var(--muted); }
  .footer { display:flex; gap:.5rem; padding:8px 12px 12px; }
  .pill { padding:.15rem .5rem; border:1px solid var(--border); border-radius:999px; background:#fff; }
  .ghost { opacity:.5; }
  .selected { outline:2px solid #2684ff; }
  .review { position:fixed; right:12px; bottom:12px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; width:360px; max-height:60vh; overflow:auto; box-shadow:0 6px 30px rgba(0,0,0,.08); }
  .kbd { border:1px solid var(--border); background:#fafafa; padding:.05rem .3rem; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; }
</style>
</head>
<body>

<header>
  <input id="q" type="search" placeholder="Filter identifiers (type to narrow)…">
  <button class="btn" id="addBucket">+ New bucket</button>
  <button class="btn" id="undoBtn" title="Undo last change"><span class="kbd">⌘Z</span> Undo</button>
  <button class="btn primary" id="saveBtn">Review & Save</button>
</header>

<main class="board" id="board" aria-label="Buckets">
  <!-- Buckets get injected here -->
</main>

<section class="review" id="review" hidden>
  <h3 style="margin:0 0 .5rem;">Changes</h3>
  <pre id="diff" style="white-space:pre-wrap; margin:0;"></pre>
  <div style="display:flex; gap:.5rem; margin-top:.5rem;">
    <button class="btn" id="closeReview">Close</button>
    <button class="btn primary" id="confirmSave">Confirm Save</button>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/plugins/SortableMultiDrag.min.js"></script>
<script>
/* -------------------------
   Demo data (replace with your API data)
   ------------------------- */
const initial = {
  // each bucket has id, label, items (first item is gold)
  buckets: [
    { id: "4623e3", label: "Moxie Marlinspike", items: ["Moxie Marlinspike","marlinspike@example.com"] },
    { id: "8f876f", label: "Ada Lovelace", items: ["Ada Lovelace","ada.lovelace@example.org"] },
    { id: "972f17", label: "Alan Turing", items: ["Alan Turing","a.turing@example.org"] },
  ],
  // original membership map (identifier -> cid) for diffing
  originalMap: {
    "Moxie Marlinspike":"4623e3", "marlinspike@example.com":"4623e3",
    "Ada Lovelace":"8f876f", "ada.lovelace@example.org":"8f876f",
    "Alan Turing":"972f17", "a.turing@example.org":"972f17",
  }
};

/* -------------------------
   Rendering
   ------------------------- */
const board = document.getElementById('board');
const q = document.getElementById('q');
const undoBtn = document.getElementById('undoBtn');
const addBucket = document.getElementById('addBucket');
const saveBtn = document.getElementById('saveBtn');

let state = structuredClone(initial);
let history = [];

function pushHistory() {
  history.push(structuredClone(state));
  if (history.length > 50) history.shift();
}

function render() {
  board.innerHTML = '';
  for (const b of state.buckets) {
    const col = document.createElement('section');
    col.className = 'col';
    col.dataset.cid = b.id;

    col.innerHTML = `
      <header>
        <input value="${b.label || ''}" placeholder="${b.id.slice(0,6)} label (optional)" class="bucketLabel">
        <span class="pill muted">${b.id.slice(0,6)}</span>
      </header>
      <ul class="list" aria-label="${b.label || b.id}">
        ${b.items.map((ident, i) => `
          <li class="card" data-ident="${ident}" ${i===0?'data-gold="true"':''} tabindex="0">
            <span class="star">${i===0?'★':''}</span>
            <span class="text">${ident}</span>
          </li>
        `).join('')}
      </ul>
      <div class="footer">
        <button class="btn del">Delete</button>
        <button class="btn" data-action="clear">Clear</button>
      </div>
    `;
    board.appendChild(col);

    // wire label change
    col.querySelector('.bucketLabel').addEventListener('input', (e) => {
      b.label = e.target.value;
    });

    // delete bucket (move items to first other bucket)
    col.querySelector('.del').addEventListener('click', () => {
      pushHistory();
      const idx = state.buckets.indexOf(b);
      const target = state.buckets.find(x => x!==b) || createBucket();
      target.items.push(...b.items);
      state.buckets.splice(idx,1);
      render();
    });

    col.querySelector('[data-action="clear"]').addEventListener('click', () => {
      pushHistory();
      b.items = [];
      render();
    });

    // Sortable per-bucket
    const sortable = new Sortable(col.querySelector('.list'), {
      group: 'ids',
      animation: 120,
      ghostClass: 'ghost',
      multiDrag: true,
      selectedClass: 'selected',
      fallbackTolerance: 4,
      onSort: () => {
        // sync the array with DOM order
        b.items = [...col.querySelectorAll('.card')].map(el => el.dataset.ident);
        markGolds();
      },
      onAdd: () => {
        // re-fill both source and destination lists into state
        syncFromDOM();
        markGolds();
      }
    });
  }
  markGolds();
  applyFilter(q.value);
}

function createBucket() {
  const id = 'new-' + Math.random().toString(36).slice(2,8);
  const b = { id, label:'', items:[] };
  state.buckets.push(b);
  return b;
}

addBucket.addEventListener('click', () => {
  pushHistory();
  createBucket();
  render();
});

undoBtn.addEventListener('click', () => {
  if (!history.length) return;
  state = history.pop();
  render();
});
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==='z') {
    e.preventDefault(); undoBtn.click();
  }
});

/* -------------------------
   Filtering
   ------------------------- */
function applyFilter(term) {
  term = (term||'').trim().toLowerCase();
  const cards = board.querySelectorAll('.card');
  for (const card of cards) {
    const t = card.querySelector('.text').textContent.toLowerCase();
    card.style.display = term && !t.includes(term) ? 'none' : '';
  }
}
q.addEventListener('input', () => applyFilter(q.value));

/* -------------------------
   State sync & gold marking
   ------------------------- */
function syncFromDOM() {
  state.buckets.forEach(b => {
    const ul = board.querySelector(`.col[data-cid="${CSS.escape(b.id)}"] .list`);
    if (!ul) return;
    b.items = [...ul.querySelectorAll('.card')].map(el => el.dataset.ident);
  });
}
function markGolds() {
  board.querySelectorAll('.list').forEach(ul => {
    ul.querySelectorAll('.card').forEach((el, idx) => {
      el.dataset.gold = (idx===0);
      el.querySelector('.star').textContent = (idx===0) ? '★' : '';
    });
  });
}

/* -------------------------
   Diff → API payload
   ------------------------- */
function buildPayload() {
  const creates = [];
  const moves = [];
  const relabels = [];

  // new buckets
  for (const b of state.buckets) {
    if (b.id.startsWith('new-') && b.items.length) {
      creates.push({ label: b.items[0], members: [...b.items] });
    }
  }

  // membership & relabels
  const newMap = {};
  for (const b of state.buckets) {
    if (!b.items.length) continue;
    if (!b.id.startsWith('new-')) {
      relabels.push({ cluster_id: b.id, label: b.items[0] });
    }
    for (const ident of b.items) newMap[ident] = b.id;
  }

  // identifier moves (existing ids only)
  for (const [ident, oldCid] of Object.entries(initial.originalMap)) {
    const newCid = newMap[ident];
    if (newCid && newCid !== oldCid) {
      moves.push({ identifier: ident, target_cluster_id: newCid });
    }
  }

  return { job_id: "YOUR_JOB_ID", creates, relabels, moves };
}

/* -------------------------
   Review & Save
   ------------------------- */
const review = document.getElementById('review');
const diffBox = document.getElementById('diff');
document.getElementById('closeReview').onclick = () => (review.hidden = true);

saveBtn.addEventListener('click', () => {
  const payload = buildPayload();
  diffBox.textContent = JSON.stringify(payload, null, 2);
  review.hidden = false;
});
document.getElementById('confirmSave').addEventListener('click', async () => {
  const payload = buildPayload();
  console.log('POST this:', payload);
  // await fetch('/index/clusters/update', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  review.hidden = true;
});

/* -------------------------
   Boot
   ------------------------- */
render();
</script>
</body>
</html>